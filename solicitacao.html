<!-- C√ìDIGO PARA COLOCAR NO SHAREPOINT (Web Part Script Editor) -->

<iframe 
    id="minhasSolicitacoesFrame" 
    src=""https://cmbsilva.github.io/Planejeti--projeto-sharepoint/MINHAS-SOLICITACOES-IFRAME.html"
    style="width: 100%; height: 800px; border: none; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);"
></iframe>

<script>
(function() {
    const iframe = document.getElementById('minhasSolicitacoesFrame');
    const siteUrl = _spPageContextInfo.webAbsoluteUrl;
    const listName = 'Solicitaes';
    const currentUserEmail = _spPageContextInfo.userEmail;
    const currentUserName = _spPageContextInfo.userDisplayName;

    console.log('üöÄ Iniciando busca de dados...');
    console.log('User:', currentUserEmail);
    console.log('Site:', siteUrl);

    // Aguardar iframe estar pronto
    window.addEventListener('message', function(event) {
        if (event.data.type === 'IFRAME_READY') {
            console.log('‚úÖ Iframe pronto, buscando dados...');
            buscarDados();
        }
    });

    // Buscar dados da lista
    function buscarDados() {
        const apiUrl = `${siteUrl}/_api/web/lists/getbytitle('${listName}')/items?$select=ID,Title,Status,Empresa,Prioridade,Solicitante,Created&$filter=Solicitante eq '${currentUserEmail}'&$orderby=Created desc&$top=100`;

        console.log('üì° API URL:', apiUrl);

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json;odata=verbose'
            }
        })
        .then(response => {
            console.log('üì• Resposta recebida:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Dados recebidos:', data.d.results.length, 'itens');
            
            // Enviar dados para o iframe
            iframe.contentWindow.postMessage({
                type: 'SHAREPOINT_DATA',
                items: data.d.results,
                siteUrl: siteUrl,
                listName: listName,
                userEmail: currentUserEmail,
                userName: currentUserName
            }, '*');
        })
        .catch(error => {
            console.error('‚ùå Erro:', error);
            
            // Enviar erro para o iframe
            iframe.contentWindow.postMessage({
                type: 'SHAREPOINT_ERROR',
                error: error.message
            }, '*');
        });
    }

    // Se o iframe j√° estiver carregado, buscar imediatamente
    iframe.addEventListener('load', function() {
        console.log('üñºÔ∏è Iframe carregado');
        // Aguardar 500ms para garantir que o script do iframe est√° pronto
        setTimeout(buscarDados, 500);
    });
})();
</script>

<style>
/* Estilos opcionais para o container */
#minhasSolicitacoesFrame {
    margin: 20px 0;
}
</style>
